# üìó –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ReportB24

–î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å ReportB24, –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –≤ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –ø–∞–π–ø–ª–∞–π–Ω—ã –∏–ª–∏ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.

<a id="–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞"></a>
## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
ReportB24
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ bitrix24_client/      # REST-–∫–ª–∏–µ–Ω—Ç –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ ProductRows API
‚îÇ   ‚îú‚îÄ‚îÄ config/               # SecureConfigReader –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
‚îÇ   ‚îú‚îÄ‚îÄ core/                 # AppFactory, workflow, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
‚îÇ   ‚îú‚îÄ‚îÄ data_processor/       # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—á–µ—Ç–æ–≤, —Ç–æ–≤–∞—Ä–æ–≤, —Ä–∞—Å—á—ë—Ç –ù–î–°
‚îÇ   ‚îî‚îÄ‚îÄ excel_generator/      # –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–≤—É—Ö–ª–∏—Å—Ç–æ–≤—ã—Ö –æ—Ç—á—ë—Ç–æ–≤
‚îú‚îÄ‚îÄ run_detailed_report.py    # –ó–∞–ø—É—Å–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–≤—É—Ö–ª–∏—Å—Ç–æ–≤–æ–≥–æ –æ—Ç—á—ë—Ç–∞
‚îî‚îÄ‚îÄ run_report.py             # –£–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–Ω—ã–π –æ–¥–Ω–æ–ª–∏—Å—Ç–æ–≤–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π
```

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
| --- | --- |
| `AppFactory` | –£–ø—Ä–∞–≤–ª—è–µ—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä, —Å–≤—è–∑—ã–≤–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é, Bitrix24Client –∏ WorkflowOrchestrator. |
| `SecureConfigReader` | –ó–∞–≥—Ä—É–∂–∞–µ—Ç `config.ini`, `.env`, –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è; –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —á—Ç–µ–Ω–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏. |
| `Bitrix24Client` | –í—ã–ø–æ–ª–Ω—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –∫–µ—à–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç—ã, —Ä–µ–∞–ª–∏–∑—É–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ fallback-—Å—Ç—Ä–∞—Ç–µ–≥–∏–∏. |
| `DataProcessor` | –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å—á–µ—Ç–æ–≤ –∏ —Ç–æ–≤–∞—Ä–æ–≤ –∫ –µ–¥–∏–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É, —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—É–º–º—ã –∏ –∞–≥—Ä–µ–≥–∞—Ç—ã. |
| `ExcelReportGenerator` | –°–æ–±–∏—Ä–∞–µ—Ç –ª–∏—Å—Ç—ã ¬´–ö—Ä–∞—Ç–∫–∏–π¬ª/¬´–ü–æ–ª–Ω—ã–π¬ª, –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Å—Ç–∏–ª–∏, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –∞–≤—Ç–æ—à–∏—Ä–∏–Ω—É –∏ ¬´–∑–µ–±—Ä–∞¬ª-—ç—Ñ—Ñ–µ–∫—Ç. |

<a id="–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è-—Å-bitrix24"></a>
## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Bitrix24

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤—Ö–æ–¥—è—â–∏–π webhook —Å –ø—Ä–∞–≤–∞–º–∏ `crm` –∏ `smart_invoice`.
- –ó–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ `Bitrix24Client`, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
  - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ (‚â§2 –∑–∞–ø—Ä–æ—Å–∞/—Å–µ–∫);
  - –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π;
  - fallback —Å–æ batch-–∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö.
- –ú–µ—Ç–æ–¥—ã –∫–ª–∏–µ–Ω—Ç–∞:
  - `get_invoices_by_period(start_date, end_date)` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—á–µ—Ç–∞;
  - `get_products_by_invoice(invoice_id)` ‚Äî –≤—ã–≥—Ä—É–∂–∞–µ—Ç —Ç–æ–≤–∞—Ä—ã –¥–ª—è —Å—á—ë—Ç–∞;
  - `get_company_info_by_invoice(account_number)` ‚Äî –≤—ã—Ç—è–≥–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ –∏ –ò–ù–ù.
- –î–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö `DataProcessor` —Å–≤—è–∑—ã–≤–∞–µ—Ç—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º —á–µ—Ä–µ–∑ `set_bitrix_client()`.

<a id="excel-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä"></a>
## üìà Excel-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä

- `ExcelReportGenerator.create_multi_sheet_report(brief_data, detailed_data, full_path)`
  - `brief_data` ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç `process_invoice_record` (–ª–∏—Å—Ç ¬´–ö—Ä–∞—Ç–∫–∏–π¬ª);
  - `detailed_data` ‚Äî –º–∞—Å—Å–∏–≤ —Å–ª–æ–≤–∞—Ä–µ–π, —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π `format_detailed_products_for_excel` (–ª–∏—Å—Ç ¬´–ü–æ–ª–Ω—ã–π¬ª).
- –§–æ—Ä–º–∞—Ç –ª–∏—Å—Ç–∞ ¬´–ü–æ–ª–Ω—ã–π¬ª (8 –∫–æ–ª–æ–Ω–æ–∫): –Ω–æ–º–µ—Ä —Å—á—ë—Ç–∞, –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç, –ò–ù–ù, —Ç–æ–≤–∞—Ä, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –µ–¥–∏–Ω–∏—Ü–∞, —Ü–µ–Ω–∞, —Å—É–º–º–∞.
- –¶–≤–µ—Ç–æ–≤—ã–µ —Å—Ö–µ–º—ã: –∑–∞–≥–æ–ª–æ–≤–∫–∏ `#FCE4D6` (¬´–ö—Ä–∞—Ç–∫–∏–π¬ª) –∏ `#C6E0B4` (¬´–ü–æ–ª–Ω—ã–π¬ª), –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π ¬´–∑–µ–±—Ä–∞¬ª-—ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤.
- –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω—ã, —à–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ.

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

- `.env` —Ö—Ä–∞–Ω–∏—Ç —Å–µ–∫—Ä–µ—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, `BITRIX_WEBHOOK_URL`).
- `config.ini` –≤–∫–ª—é—á–∞–µ—Ç —Å–µ–∫—Ü–∏–∏:
  - `[AppSettings]`: `defaultsavefolder`, `defaultfilename`, `loglevel`, `logfile`.
  - `[ReportPeriod]`: `startdate`, `enddate`.
- `SecureConfigReader.get_safe_config_info()` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤ –ª–æ–≥–∞—Ö.
- –í—Å–µ –ø—É—Ç–∏ –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è; –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏–∑–º–µ–Ω—è–π—Ç–µ `defaultsavefolder`.

## üîÑ –ü–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `run_detailed_report.py`

1. –ü–µ—á–∞—Ç—å –±–∞–Ω–Ω–µ—Ä–∞ –∏ –∏—Å—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.
2. –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ `AppFactory.create_app('config.ini')`.
3. –ß—Ç–µ–Ω–∏–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–≤–æ–¥ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (`get_safe_config_info`).
4. –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (`validate_configuration`).
5. –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Bitrix24 (`test_api_connection`).
6. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—á–µ—Ç–æ–≤ –∏ —Ç–æ–≤–∞—Ä–æ–≤, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `DataProcessor` –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö.
7. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–≤—É—Ö–ª–∏—Å—Ç–æ–≤–æ–≥–æ –æ—Ç—á—ë—Ç–∞.
8. –ò—Ç–æ–≥–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π (–≤–∫–ª—é—á–∞—è –ø—Ä–∏—á–∏–Ω—ã —Å–±–æ–µ–≤).

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ CI

- –í—Å–µ —Ç–µ—Å—Ç—ã —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω—ã –≤ –∫–∞—Ç–∞–ª–æ–≥–µ `tests/`; –∑–∞–ø—É—Å–∫ ‚Äî `pytest -v`.
- –ü–æ–∫—Ä—ã—Ç–∏–µ: `pytest --cov=src --cov-report=html`.
- CI/CD: GitHub Actions, —Å—Ü–µ–Ω–∞—Ä–∏–π `security-check.yml` –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–∞.

## üöÄ –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

- **–ù–æ–≤—ã–µ API Bitrix24:** –¥–æ–±–∞–≤–ª—è–π—Ç–µ –º–µ—Ç–æ–¥—ã –≤ `Bitrix24Client` –∏ –æ—Ç—Ä–∞–∂–∞–π—Ç–µ –∏—Ö –≤ `DataProcessor`.
- **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ª–∏—Å—Ç—ã Excel:** —Ä–∞—Å—à–∏—Ä—è–π—Ç–µ `ExcelReportGenerator` –∏–ª–∏ –≤–Ω–µ–¥—Ä—è–π—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –±–∏–ª–¥–µ—Ä—ã.
- **–õ–æ–≥–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –ø–æ–¥–∫–ª—é—á–∞–π—Ç–µ –≤–Ω–µ—à–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã, –∏—Å–ø–æ–ª—å–∑—É—è `logging` –∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏.
- **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è:** –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Dockerfile –∏–∑ [–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞](USER_GUIDE.md#docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä) –∫–∞–∫ –æ—Å–Ω–æ–≤—É –¥–ª—è production-—Å–±–æ—Ä–æ–∫.

