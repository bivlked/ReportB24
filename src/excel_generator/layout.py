"""
Excel layout module for Bitrix24 report generation.

Defines the report structure, headers, and column configuration
that exactly matches the provided screenshots.
"""

from typing import List, Dict, Any, Tuple
from dataclasses import dataclass
from openpyxl import Workbook
from openpyxl.worksheet.worksheet import Worksheet


@dataclass
class ColumnDefinition:
    """Definition for a single report column."""
    
    header: str           # Column header text
    width: float         # Column width in Excel units
    alignment: str       # Text alignment: 'left', 'center', 'right'
    data_key: str        # Key in data dict for this column


class ReportLayout:
    """
    Report layout configuration matching the screenshot requirements.
    
    Defines column structure, headers, and layout parameters
    for the Bitrix24 invoice report.
    """
    
    # Column definitions matching the screenshot
    COLUMNS = [
        ColumnDefinition(
            header="–ù–æ–º–µ—Ä",
            width=15.0,
            alignment="center",
            data_key="invoice_number"
        ),
        ColumnDefinition(
            header="–ò–ù–ù",
            width=15.0,
            alignment="center",
            data_key="inn"
        ),
        ColumnDefinition(
            header="–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç",
            width=30.0,
            alignment="left",
            data_key="contractor_name"
        ),
        ColumnDefinition(
            header="–°—É–º–º–∞",
            width=18.0,
            alignment="right",
            data_key="total_amount"
        ),
        ColumnDefinition(
            header="–ù–î–°",
            width=18.0,
            alignment="center",
            data_key="vat_amount"
        ),
        ColumnDefinition(
            header="–î–∞—Ç–∞ —Å—á—ë—Ç–∞",
            width=15.0,
            alignment="right",
            data_key="invoice_date"
        ),
        ColumnDefinition(
            header="–î–∞—Ç–∞ –æ—Ç–≥—Ä—É–∑–∫–∏",
            width=15.0,
            alignment="right",
            data_key="shipment_date"
        ),
        ColumnDefinition(
            header="–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã",
            width=15.0,
            alignment="right",
            data_key="payment_date"
        ),
    ]
    
    # Layout constants
    HEADER_ROW = 2          # Row for headers (1-based, skip empty row)
    DATA_START_ROW = 3      # First data row (1-based)
    START_COLUMN = 2        # Starting column (1-based, skip empty column)
    
    def __init__(self):
        self.total_columns = len(self.COLUMNS)
    
    def setup_worksheet(self, ws: Worksheet) -> None:
        """
        Set up worksheet with proper structure and column widths.
        
        Args:
            ws: OpenPyXL worksheet object
        """
        # Set column widths
        for i, col_def in enumerate(self.COLUMNS, start=self.START_COLUMN):
            col_letter = ws.cell(row=1, column=i).column_letter
            ws.column_dimensions[col_letter].width = col_def.width
        
        # Set row heights
        ws.row_dimensions[self.HEADER_ROW].height = 20  # Header row height
        
        # Freeze panes (freeze first row and first column)
        # This allows headers to stay visible when scrolling
        freeze_cell = ws.cell(row=self.DATA_START_ROW, column=self.START_COLUMN)
        ws.freeze_panes = freeze_cell
    
    def write_headers(self, ws: Worksheet) -> None:
        """
        Write column headers to the worksheet.
        
        Args:
            ws: OpenPyXL worksheet object
        """
        for i, col_def in enumerate(self.COLUMNS, start=self.START_COLUMN):
            cell = ws.cell(row=self.HEADER_ROW, column=i)
            cell.value = col_def.header
    
    def get_data_cell_position(self, row_index: int, column_index: int) -> Tuple[int, int]:
        """
        Get Excel cell position for data.
        
        Args:
            row_index: 0-based data row index
            column_index: 0-based column index
            
        Returns:
            Tuple of (row, column) in 1-based Excel coordinates
        """
        excel_row = self.DATA_START_ROW + row_index
        excel_col = self.START_COLUMN + column_index
        return excel_row, excel_col
    
    def get_column_key(self, column_index: int) -> str:
        """
        Get data key for a column.
        
        Args:
            column_index: 0-based column index
            
        Returns:
            Data key string for this column
        """
        if 0 <= column_index < len(self.COLUMNS):
            return self.COLUMNS[column_index].data_key
        return ""
    
    def get_column_alignment(self, column_index: int) -> str:
        """
        Get alignment for a column.
        
        Args:
            column_index: 0-based column index
            
        Returns:
            Alignment type: 'left', 'center', or 'right'
        """
        if 0 <= column_index < len(self.COLUMNS):
            return self.COLUMNS[column_index].alignment
        return "left"
    
    def get_column_headers(self) -> List[str]:
        """
        Get list of column headers.
        
        Returns:
            List of column header strings
        """
        return [col_def.header for col_def in self.COLUMNS]


class SummaryLayout:
    """
    Layout for summary/totals section at the bottom of the report.
    
    Provides structure for totals and statistics that appear
    below the main data table.
    """
    
    def __init__(self, layout: ReportLayout):
        self.layout = layout
    
    def add_summary_section(self, ws: Worksheet, data_row_count: int, 
                          totals: Dict[str, Any]) -> None:
        """
        Add summary section with totals below the data.
        
        Args:
            ws: OpenPyXL worksheet object
            data_row_count: Number of data rows written
            totals: Dictionary with total amounts
        """
        # Calculate summary start row (2 rows below last data)
        summary_start_row = self.layout.DATA_START_ROW + data_row_count + 2
        
        # Total count
        count_row = summary_start_row
        ws.cell(row=count_row, column=self.layout.START_COLUMN).value = "–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π:"
        ws.cell(row=count_row, column=self.layout.START_COLUMN + 1).value = data_row_count
        
        # Total amounts
        if 'amount_without_vat' in totals:
            amount_row = summary_start_row + 1
            ws.cell(row=amount_row, column=self.layout.START_COLUMN).value = "–û–±—â–∞—è —Å—É–º–º–∞ –±–µ–∑ –ù–î–°:"
            ws.cell(row=amount_row, column=self.layout.START_COLUMN + 4).value = totals['amount_without_vat']
        
        if 'amount_with_vat' in totals:
            total_row = summary_start_row + 2
            ws.cell(row=total_row, column=self.layout.START_COLUMN).value = "–û–±—â–∞—è —Å—É–º–º–∞ —Å –ù–î–°:"
            ws.cell(row=total_row, column=self.layout.START_COLUMN + 6).value = totals['amount_with_vat']


class WorksheetBuilder:
    """
    Builder class for creating and configuring Excel worksheets.
    
    Combines layout configuration with styling to create
    properly formatted worksheets.
    """
    
    def __init__(self):
        self.layout = ReportLayout()
        self.summary = SummaryLayout(self.layout)
    
    def create_worksheet(self, workbook: Workbook, sheet_name: str = "–û—Ç—á—ë—Ç") -> Worksheet:
        """
        Create and configure a new worksheet.
        
        Args:
            workbook: OpenPyXL workbook object
            sheet_name: Name for the worksheet
            
        Returns:
            Configured worksheet object
        """
        # Create or get worksheet
        if workbook.worksheets:
            ws = workbook.active
            ws.title = sheet_name
        else:
            ws = workbook.create_sheet(sheet_name)
        
        # Apply layout configuration
        self.layout.setup_worksheet(ws)
        self.layout.write_headers(ws)
        
        return ws
    
    def calculate_totals(self, data: List[Dict[str, Any]]) -> Dict[str, Any]:
        """
        Calculate totals for the summary section.
        
        Args:
            data: List of data rows
            
        Returns:
            Dictionary with calculated totals
        """
        totals = {
            'count': len(data),
            'amount_without_vat': 0.0,
            'amount_with_vat': 0.0
        }
        
        for row in data:
            # Add amounts (handle both string and numeric values)
            if 'amount_without_vat' in row:
                amount = row['amount_without_vat']
                if isinstance(amount, (int, float)):
                    totals['amount_without_vat'] += amount
            
            if 'amount_with_vat' in row:
                amount = row['amount_with_vat']
                if isinstance(amount, (int, float)):
                    totals['amount_with_vat'] += amount
        
        return totals


# ============================================================================
# –î–ï–¢–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢ LAYOUT - –§–ê–ó–ê 4: EXCEL –ì–ï–ù–ï–†–ê–¶–ò–Ø
# ============================================================================

class DetailedReportLayout:
    """
    Layout configuration for detailed report with product breakdown.
    
    –°–æ–∑–¥–∞–µ—Ç –º–∞–∫–µ—Ç –¥–ª—è –ª–∏—Å—Ç–∞ "–ü–æ–ª–Ω—ã–π" —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–æ–≤–∞—Ä–∞—Ö.
    –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å DataProcessor –∏–∑ –§–∞–∑—ã 3 –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤.
    """
    
    # üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
    COLUMNS = [
        ColumnDefinition(
            header="–ù–æ–º–µ—Ä",  # –ò–∑–º–µ–Ω–µ–Ω–æ —Å "–ù–æ–º–µ—Ä —Å—á—ë—Ç–∞"
            width=18.0,
            alignment="center",
            data_key="invoice_number"
        ),
        ColumnDefinition(
            header="–ò–ù–ù",  # –ü–æ–º–µ–Ω—è–Ω—ã –º–µ—Å—Ç–∞–º–∏ —Å "–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç"
            width=15.0,
            alignment="center",
            data_key="inn"
        ),
        ColumnDefinition(
            header="–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç",  # –ü–æ–º–µ–Ω—è–Ω—ã –º–µ—Å—Ç–∞–º–∏ —Å "–ò–ù–ù"
            width=25.0,
            alignment="left", 
            data_key="company_name"
        ),
        ColumnDefinition(
            header="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞",
            width=35.0,
            alignment="left",
            data_key="product_name"
        ),
        ColumnDefinition(
            header="–ö–æ–ª-–≤–æ",
            width=12.0,
            alignment="center",  # –ò–∑–º–µ–Ω–µ–Ω–æ —Å "right" –Ω–∞ "center"
            data_key="quantity"
        ),
        ColumnDefinition(
            header="–¶–µ–Ω–∞",
            width=15.0,
            alignment="right",
            data_key="price"
        ),
        ColumnDefinition(
            header="–°—É–º–º–∞",
            width=18.0,
            alignment="right",
            data_key="total_amount"
        ),
        ColumnDefinition(
            header="–°—É–º–º–∞ –ù–î–°",
            width=15.0,
            alignment="right",
            data_key="vat_amount"
        ),
    ]
    
    # Layout constants (same as brief report for consistency)
    HEADER_ROW = 2
    DATA_START_ROW = 3
    START_COLUMN = 2
    
    # Green header color from Hello World Excel Test
    HEADER_FILL_COLOR = "C6E0B4"  # Green color for headers
    
    def __init__(self):
        self.total_columns = len(self.COLUMNS)
    
    def setup_worksheet(self, ws: Worksheet) -> None:
        """
        Set up detailed worksheet with proper structure and styling.
        
        üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:
        - –°—Ç–æ–ª–±–µ—Ü A —É–∑–∫–∏–π (–∫–∞–∫ –≤—ã—Å–æ—Ç–∞ —Å—Ç—Ä–æ–∫–∏)
        - –£–±—Ä–∞–Ω–∞ –∑–∞–º–æ—Ä–æ–∑–∫–∞ —Å—Ç–æ–ª–±—Ü–æ–≤ (—Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤)
        - –ê–≤—Ç–æ—à–∏—Ä–∏–Ω–∞ –¥–ª—è –≤—Å–µ—Ö —Å—Ç–æ–ª–±—Ü–æ–≤
        
        Args:
            ws: OpenPyXL worksheet object
        """
        from openpyxl.styles import PatternFill, Border, Side, Alignment
        from openpyxl.utils import get_column_letter
        
        # üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –°—Ç–æ–ª–±–µ—Ü A —É–∑–∫–∏–π (–∫–∞–∫ –≤—ã—Å–æ—Ç–∞ —Å—Ç—Ä–æ–∫–∏)
        ws.column_dimensions['A'].width = 3  # –£–∑–∫–∏–π —Å—Ç–æ–ª–±–µ—Ü A
        
        # üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –ê–≤—Ç–æ—à–∏—Ä–∏–Ω–∞ –¥–ª—è –≤—Å–µ—Ö –∫–æ–ª–æ–Ω–æ–∫ –¥–∞–Ω–Ω—ã—Ö
        # –í—Ä–µ–º–µ–Ω–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞–∑–æ–≤—ã–µ —à–∏—Ä–∏–Ω—ã, –∑–∞—Ç–µ–º –±—É–¥–µ—Ç –∞–≤—Ç–æ–ø–æ–¥–±–æ—Ä
        for i, col_def in enumerate(self.COLUMNS, start=self.START_COLUMN):
            col_letter = get_column_letter(i)
            ws.column_dimensions[col_letter].width = col_def.width
        
        # üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–Ω–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É —Å—Ç—Ä–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –º–µ–∂–¥—É –ª–∏—Å—Ç–∞–º–∏
        ws.row_dimensions[self.HEADER_ROW].height = 18  # –û–¥–∏–Ω–∞–∫–æ–≤–∞—è –≤—ã—Å–æ—Ç–∞ —Å –ª–∏—Å—Ç–æ–º "–ö—Ä–∞—Ç–∫–∏–π"
        
        # üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 3: –ó–∞–º–æ—Ä–æ–∑–∫–∞ –¢–û–õ–¨–ö–û —Å—Ç—Ä–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (–±–µ–∑ —Å—Ç–æ–ª–±—Ü–æ–≤)
        # –ó–∞–º–æ—Ä–æ–∑–∫–∞ –Ω–∞ A3 –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –∑–∞–º–æ—Ä–æ–∂–µ–Ω—ã —Å—Ç—Ä–æ–∫–∏ 1-2, –Ω–æ —Å—Ç–æ–ª–±—Ü—ã —Å–≤–æ–±–æ–¥–Ω—ã
        freeze_cell = f"A{self.DATA_START_ROW}"
        ws.freeze_panes = freeze_cell
        
        # Apply header styling (green background)
        header_fill = PatternFill(start_color=self.HEADER_FILL_COLOR, 
                                end_color=self.HEADER_FILL_COLOR, 
                                fill_type="solid")
        
        # Border style for professional look
        border_style = Border(
            left=Side(style='thin'),
            right=Side(style='thin'),
            top=Side(style='thin'),
            bottom=Side(style='thin')
        )
        
        # Apply styling to header row
        for i in range(self.START_COLUMN, self.START_COLUMN + self.total_columns):
            header_cell = ws.cell(row=self.HEADER_ROW, column=i)
            header_cell.fill = header_fill
            header_cell.border = border_style
            header_cell.alignment = Alignment(horizontal="center", vertical="center")
            
            # üîß –£–ù–ò–§–ò–ö–ê–¶–ò–Ø: –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–æ—Ç –∂–µ —Å—Ç–∏–ª—å —à—Ä–∏—Ñ—Ç–∞ –∫–∞–∫ –≤ –∫—Ä–∞—Ç–∫–æ–º –æ—Ç—á–µ—Ç–µ
            from openpyxl.styles import Font
            header_cell.font = Font(bold=True, color="000000")  # –ñ–∏—Ä–Ω—ã–π —á–µ—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
    
    def write_headers(self, ws: Worksheet) -> None:
        """
        Write column headers for detailed report.
        
        Args:
            ws: OpenPyXL worksheet object
        """
        for i, col_def in enumerate(self.COLUMNS, start=self.START_COLUMN):
            cell = ws.cell(row=self.HEADER_ROW, column=i)
            cell.value = col_def.header
    
    def apply_zebra_effect(self, ws: Worksheet, data_rows: List[Dict[str, Any]]) -> None:
        """
        –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∑–µ–±—Ä–∞-—ç—Ñ—Ñ–µ–∫—Ç–∞ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ø–æ —Å—á–µ—Ç–∞–º.
        
        –ß–µ—Ä–µ–¥—É–µ—Ç —Ü–≤–µ—Ç —Å—Ç—Ä–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ —Å—á–µ—Ç–∞, —á—Ç–æ–±—ã
        –≤–∏–∑—É–∞–ª—å–Ω–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å —Ç–æ–≤–∞—Ä—ã —Ä–∞–∑–Ω—ã—Ö —Å—á–µ—Ç–æ–≤.
        
        Args:
            ws: OpenPyXL worksheet object  
            data_rows: –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ –¥–∞–Ω–Ω—ã—Ö —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
        """
        from openpyxl.styles import PatternFill
        
        # Colors for zebra effect (light gray for alternating invoices)
        zebra_color = "F2F2F2"  # Light gray
        zebra_fill = PatternFill(start_color=zebra_color, 
                               end_color=zebra_color, 
                               fill_type="solid")
        
        current_invoice_id = None
        use_zebra = False
        
        for row_idx, row_data in enumerate(data_rows):
            invoice_id = row_data.get('invoice_id')
            
            # Check if we're starting a new invoice group
            if invoice_id != current_invoice_id:
                current_invoice_id = invoice_id
                use_zebra = not use_zebra  # Toggle zebra effect
            
            # Apply zebra fill to this row if needed
            if use_zebra:
                excel_row = self.DATA_START_ROW + row_idx
                for col_idx in range(self.START_COLUMN, self.START_COLUMN + self.total_columns):
                    cell = ws.cell(row=excel_row, column=col_idx)
                    cell.fill = zebra_fill

    def apply_invoice_separator_borders(self, ws: Worksheet, data_rows: List[Dict[str, Any]]) -> None:
        """
        –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–æ–ª—Å—Ç—ã—Ö –Ω–∏–∂–Ω–∏—Ö –≥—Ä–∞–Ω–∏—Ü –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å—á–µ—Ç–æ–≤.
        
        –°–æ–≥–ª–∞—Å–Ω–æ Creative Phase —Ä–µ—à–µ–Ω–∏—é: "Thick Bottom Border –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–∏ –∫–∞–∂–¥–æ–≥–æ —Å—á–µ—Ç–∞"
        –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≤–∏–∑—É–∞–ª—å–Ω—É—é —è—Å–Ω–æ—Å—Ç—å –≥—Ä–∞–Ω–∏—Ü –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏.
        
        Args:
            ws: OpenPyXL worksheet object
            data_rows: –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ –¥–∞–Ω–Ω—ã—Ö —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
        """
        from openpyxl.styles import Border, Side
        
        if not data_rows:
            return
        
        # –°–æ–∑–¥–∞–µ–º —Å—Ç–∏–ª—å –¥–ª—è –≥—Ä–∞–Ω–∏—Ü—ã –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏
        thin_side = Side(border_style="thin", color="000000")
        medium_side = Side(border_style="medium", color="000000")
        
        separator_border = Border(
            left=thin_side,
            right=thin_side,
            top=thin_side,
            bottom=medium_side  # –¢–æ–ª—Å—Ç–∞—è –Ω–∏–∂–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞
        )
        
        current_invoice_id = None
        last_invoice_row = None
        
        # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É –∫–∞–∂–¥–æ–≥–æ —Å—á–µ—Ç–∞
        for row_idx, row_data in enumerate(data_rows):
            invoice_id = row_data.get('invoice_id')
            
            # –ï—Å–ª–∏ –Ω–∞—á–∞–ª—Å—è –Ω–æ–≤—ã–π —Å—á–µ—Ç –∏ —É –Ω–∞—Å –µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π - –ø—Ä–∏–º–µ–Ω—è–µ–º –≥—Ä–∞–Ω–∏—Ü—É
            if invoice_id != current_invoice_id and last_invoice_row is not None:
                self._apply_separator_border_to_row(ws, last_invoice_row, separator_border)
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ
            if invoice_id != current_invoice_id:
                current_invoice_id = invoice_id
            
            last_invoice_row = row_idx
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –≥—Ä–∞–Ω–∏—Ü—É –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å—á–µ—Ç–∞
        if last_invoice_row is not None:
            self._apply_separator_border_to_row(ws, last_invoice_row, separator_border)
    
    def _apply_separator_border_to_row(self, ws: 'Worksheet', row_idx: int, border) -> None:
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç –≥—Ä–∞–Ω–∏—Ü—É —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–æ–∫–µ.
        
        Args:
            ws: OpenPyXL worksheet object
            row_idx: –ò–Ω–¥–µ–∫—Å —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö (0-based)
            border: –°—Ç–∏–ª—å –≥—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
        """
        excel_row = self.DATA_START_ROW + row_idx
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –≥—Ä–∞–Ω–∏—Ü—É –∫–æ –≤—Å–µ–º —è—á–µ–π–∫–∞–º —Å—Ç—Ä–æ–∫–∏
        for col_idx in range(len(self.COLUMNS)):
            excel_col = self.START_COLUMN + col_idx
            cell = ws.cell(row=excel_row, column=excel_col)
            
            # –ü—Ä–æ—Å—Ç–æ –ø—Ä–∏–º–µ–Ω—è–µ–º –≥—Ä–∞–Ω–∏—Ü—É, –Ω–µ —Ç—Ä–æ–≥–∞—è –∑–∞–ª–∏–≤–∫—É
            # (–∑–∞–ª–∏–≤–∫–∞ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Ä–∞–Ω–µ–µ —á–µ—Ä–µ–∑ zebra-—Å—Ç–∏–ª–∏–∑–∞—Ü–∏—é)
            cell.border = border

    def get_data_cell_position(self, row_index: int, column_index: int) -> Tuple[int, int]:
        """
        Get Excel cell position for detailed data.
        
        Args:
            row_index: 0-based data row index
            column_index: 0-based column index
            
        Returns:
            Tuple of (row, column) in 1-based Excel coordinates
        """
        excel_row = self.DATA_START_ROW + row_index
        excel_col = self.START_COLUMN + column_index
        return excel_row, excel_col
    
    def get_column_key(self, column_index: int) -> str:
        """Get data key for a column in detailed report."""
        if 0 <= column_index < len(self.COLUMNS):
            return self.COLUMNS[column_index].data_key
        return ""
    
    def get_column_alignment(self, column_index: int) -> str:
        """Get alignment for a column in detailed report."""
        if 0 <= column_index < len(self.COLUMNS):
            return self.COLUMNS[column_index].alignment
        return "left"
    
    def get_column_headers(self) -> List[str]:
        """Get list of column headers for detailed report."""
        return [col_def.header for col_def in self.COLUMNS]


class DetailedWorksheetBuilder:
    """
    Builder for creating detailed report worksheets.
    
    –°–æ–∑–¥–∞–µ—Ç –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ª–∏—Å—Ç—ã –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ —Å —Ç–æ–≤–∞—Ä–∞–º–∏.
    –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å DataProcessor –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö.
    """
    
    def __init__(self):
        self.layout = DetailedReportLayout()
    
    def create_detailed_worksheet(
        self, 
        workbook: Workbook, 
        sheet_name: str = "–ü–æ–ª–Ω—ã–π"
    ) -> Worksheet:
        """
        Create and configure detailed worksheet.
        
        Args:
            workbook: OpenPyXL workbook object
            sheet_name: Name for the detailed worksheet
            
        Returns:
            Configured detailed worksheet object
        """
        # Create new worksheet (don't replace existing ones)
        ws = workbook.create_sheet(sheet_name)
        
        # Apply detailed layout configuration
        self.layout.setup_worksheet(ws)
        self.layout.write_headers(ws)
        
        return ws
    
    def write_detailed_data(
        self, 
        ws: Worksheet, 
        data_rows: List[Dict[str, Any]]
    ) -> None:
        """
        Write detailed product data to worksheet.
        
        –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–æ–≤ —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –∑–µ–±—Ä–∞-—ç—Ñ—Ñ–µ–∫—Ç–∞
        –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ø–æ —Å—á–µ—Ç–∞–º.
        
        Args:
            ws: OpenPyXL worksheet object
            data_rows: List of formatted product data from DataProcessor
        """
        from openpyxl.styles import Alignment, Border, Side
        
        # Border for data cells
        border_style = Border(
            left=Side(style='thin'),
            right=Side(style='thin'),
            top=Side(style='thin'),
            bottom=Side(style='thin')
        )
        
        # Write data rows
        for row_idx, row_data in enumerate(data_rows):
            for col_idx, col_def in enumerate(self.layout.COLUMNS):
                excel_row, excel_col = self.layout.get_data_cell_position(row_idx, col_idx)
                
                cell = ws.cell(row=excel_row, column=excel_col)
                cell.value = row_data.get(col_def.data_key, "")
                
                # Apply alignment
                cell.alignment = Alignment(horizontal=col_def.alignment, vertical="center")
                
                # üîß –£–ù–ò–§–ò–ö–ê–¶–ò–Ø: –ü—Ä–∏–º–µ–Ω—è–µ–º —á–∏—Å–ª–æ–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∫ –≤ –∫—Ä–∞—Ç–∫–æ–º –æ—Ç—á–µ—Ç–µ
                cell.number_format = self._get_detailed_column_number_format(col_idx)
                
                # Apply border
                cell.border = border_style
        
        # Apply zebra effect after writing all data
        self.layout.apply_zebra_effect(ws, data_rows)
        
        # Apply thick borders between invoices
        self.layout.apply_invoice_separator_borders(ws, data_rows)
        
        # üîß –£–ù–ò–§–ò–ö–ê–¶–ò–Ø: –ü—Ä–∏–º–µ–Ω—è–µ–º –∂–∏—Ä–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –≤–æ–∫—Ä—É–≥ —Ç–∞–±–ª–∏—Ü—ã –∫–∞–∫ –≤ –∫—Ä–∞—Ç–∫–æ–º –æ—Ç—á–µ—Ç–µ
        self._apply_detailed_table_borders(ws, len(data_rows))
        
        # üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ê–≤—Ç–æ–ø–æ–¥–±–æ—Ä —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö
        self._adjust_detailed_column_widths(ws, data_rows)
    
    def _get_detailed_column_number_format(self, col_idx: int) -> str:
        """
        üîß –£–ù–ò–§–ò–ö–ê–¶–ò–Ø: –ß–∏—Å–ª–æ–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
        
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ç–∞–∫–æ–µ –∂–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∫ –≤ –∫—Ä–∞—Ç–∫–æ–º –æ—Ç—á–µ—Ç–µ:
        - –ò–ù–ù (–∏–Ω–¥–µ–∫—Å 2): '0' - —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
        - –ö–æ–ª-–≤–æ, –¶–µ–Ω–∞, –°—É–º–º–∞ (–∏–Ω–¥–µ–∫—Å—ã 4, 6, 7): '#,##0.00' - —á–∏—Å–ª–∞ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏
        - –û—Å—Ç–∞–ª—å–Ω—ã–µ: 'General' - –æ–±—ã—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        
        Args:
            col_idx: –ò–Ω–¥–µ–∫—Å —Å—Ç–æ–ª–±—Ü–∞ (0-based)
            
        Returns:
            –°—Ç—Ä–æ–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ —á–∏—Å–ª–∞ –¥–ª—è Excel
        """
        # üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞:
        # 0: –ù–æ–º–µ—Ä (—Ç–µ–∫—Å—Ç)
        # 1: –ò–ù–ù (—á–∏—Å–ª–æ) - –ø–æ–º–µ–Ω—è–ª–∏—Å—å –º–µ—Å—Ç–∞–º–∏ —Å –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç
        # 2: –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç (—Ç–µ–∫—Å—Ç) - –ø–æ–º–µ–Ω—è–ª–∏—Å—å –º–µ—Å—Ç–∞–º–∏ —Å –ò–ù–ù
        # 3: –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (—Ç–µ–∫—Å—Ç)
        # 4: –ö–æ–ª-–≤–æ (–¶–ï–õ–û–ï —á–∏—Å–ª–æ) - —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        # 5: –ï–¥. –∏–∑–º. (—Ç–µ–∫—Å—Ç)
        # 6: –¶–µ–Ω–∞ (—á–∏—Å–ª–æ —Å 2 –∑–Ω–∞–∫–∞–º–∏)
        # 7: –°—É–º–º–∞ (—á–∏—Å–ª–æ —Å 2 –∑–Ω–∞–∫–∞–º–∏)
        
        if col_idx == 1:  # –ò–ù–ù (—Ç–µ–ø–µ—Ä—å –≤—Ç–æ—Ä–æ–π —Å—Ç–æ–ª–±–µ—Ü)
            return '0'  # –¶–µ–ª–æ–µ —á–∏—Å–ª–æ –±–µ–∑ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π (–∫–∞–∫ –≤ –∫—Ä–∞—Ç–∫–æ–º –æ—Ç—á–µ—Ç–µ)
        elif col_idx == 4:  # –ö–æ–ª-–≤–æ - –¶–ï–õ–´–ï —á–∏—Å–ª–∞ (–±–µ–∑ –¥—Ä–æ–±–Ω–æ–π —á–∞—Å—Ç–∏)
            return '0'  # –¶–µ–ª–æ–µ —á–∏—Å–ª–æ –±–µ–∑ –¥—Ä–æ–±–Ω–æ–π —á–∞—Å—Ç–∏
        elif col_idx in [6, 7]:  # –¶–µ–Ω–∞, –°—É–º–º–∞
            return '#,##0.00'  # –ß–∏—Å–ª–æ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á –∏ 2 –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
        else:
            return 'General'  # –û–±—ã—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
    
    def _apply_detailed_table_borders(self, ws: Worksheet, data_rows: int) -> None:
        """
        üîß –£–ù–ò–§–ò–ö–ê–¶–ò–Ø: –ü—Ä–∏–º–µ–Ω—è–µ—Ç –∂–∏—Ä–Ω—É—é —Ä–∞–º–∫—É –≤–æ–∫—Ä—É–≥ —Ç–∞–±–ª–∏—Ü—ã –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
        
        –¢–æ—á–Ω–æ —Ç–∞–∫–∞—è –∂–µ –ª–æ–≥–∏–∫–∞ –∫–∞–∫ –≤ _apply_data_table_borders() –∫—Ä–∞—Ç–∫–æ–≥–æ –æ—Ç—á–µ—Ç–∞.
        
        Args:
            ws: –†–∞–±–æ—á–∏–π –ª–∏—Å—Ç
            data_rows: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –¥–∞–Ω–Ω—ã—Ö
        """
        from openpyxl.styles import Border, Side
        
        thick_border = Side(border_style="thick", color="000000")
        
        # –†–∞–º–∫–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ü–û–°–õ–ï –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        last_data_row = self.layout.DATA_START_ROW + data_rows - 1  # –∑–∞–≥–æ–ª–æ–≤–∫–∏ + –¥–∞–Ω–Ω—ã–µ  
        last_col = self.layout.START_COLUMN + self.layout.total_columns - 1  # –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–æ–ª–±–µ—Ü
        
        # –ñ–∏—Ä–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–ª—å–∫–æ –≤–æ–∫—Ä—É–≥ —Ç–∞–±–ª–∏—Ü—ã —Å –¥–∞–Ω–Ω—ã–º–∏ (–ë–ï–ó –∏—Ç–æ–≥–æ–≤)
        for row in range(self.layout.HEADER_ROW, last_data_row + 1):
            for col in range(self.layout.START_COLUMN, last_col + 1):
                cell = ws.cell(row=row, column=col)
                
                border_left = thick_border if col == self.layout.START_COLUMN else cell.border.left
                border_right = thick_border if col == last_col else cell.border.right  
                border_top = thick_border if row == self.layout.HEADER_ROW else cell.border.top
                border_bottom = thick_border if row == last_data_row else cell.border.bottom
                
                cell.border = Border(
                    left=border_left,
                    right=border_right,
                    top=border_top,
                    bottom=border_bottom
                )
    
    def add_detailed_summary(
        self, 
        ws: Worksheet, 
        data_row_count: int,
        summary_stats: Dict[str, Any]
    ) -> None:
        """
        Add summary section for detailed report.
        
        Args:
            ws: OpenPyXL worksheet object
            data_row_count: Number of product rows written
            summary_stats: Summary statistics (total products, invoices, etc.)
        """
        # Calculate summary start row
        summary_start_row = self.layout.DATA_START_ROW + data_row_count + 2
        
        # Products count
        ws.cell(row=summary_start_row, column=self.layout.START_COLUMN).value = "–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤:"
        ws.cell(row=summary_start_row, column=self.layout.START_COLUMN + 1).value = data_row_count
        
        # Invoices count
        if 'total_invoices' in summary_stats:
            invoices_row = summary_start_row + 1
            ws.cell(row=invoices_row, column=self.layout.START_COLUMN).value = "–í—Å–µ–≥–æ —Å—á–µ—Ç–æ–≤:"
            ws.cell(row=invoices_row, column=self.layout.START_COLUMN + 1).value = summary_stats['total_invoices']
    
    def _adjust_detailed_column_widths(self, ws: Worksheet, data_rows: List[Dict[str, Any]]) -> None:
        """
        üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ê–≤—Ç–æ–ø–æ–¥–±–æ—Ä —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
        
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É
        –¥–ª—è –≤—Å–µ—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ (–∫–∞–∫ —Ç—Ä–µ–±–æ–≤–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å).
        
        Args:
            ws: –†–∞–±–æ—á–∏–π –ª–∏—Å—Ç
            data_rows: –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        """
        from openpyxl.utils import get_column_letter
        
        if not data_rows:
            return
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–ª–∏–Ω—É –¥–∞–Ω–Ω—ã—Ö –≤ –∫–∞–∂–¥–æ–º —Å—Ç–æ–ª–±—Ü–µ
        max_lengths = {}
        
        for col_idx, col_def in enumerate(self.layout.COLUMNS):
            data_key = col_def.data_key
            header_length = len(col_def.header)
            
            # –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞
            max_data_length = 0
            for row in data_rows:
                value = str(row.get(data_key, ""))
                max_data_length = max(max_data_length, len(value))
            
            # –£—á–∏—Ç—ã–≤–∞–µ–º –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫, –∏ –¥–∞–Ω–Ω—ã–µ + –Ω–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø
            optimal_width = max(header_length, max_data_length) + 2
            
            # –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ —Ç–∏–ø—É —Å—Ç–æ–ª–±—Ü–∞
            if data_key == "inn":
                optimal_width = max(optimal_width, 12)  # –ú–∏–Ω–∏–º—É–º –¥–ª—è –ò–ù–ù
                optimal_width = min(optimal_width, 20)  # –ú–∞–∫—Å–∏–º—É–º –¥–ª—è –ò–ù–ù
            elif data_key == "company_name":
                optimal_width = max(optimal_width, 20)  # –ú–∏–Ω–∏–º—É–º –¥–ª—è –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞
                optimal_width = min(optimal_width, 50)  # –ú–∞–∫—Å–∏–º—É–º –¥–ª—è –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞
            elif data_key == "product_name":
                optimal_width = max(optimal_width, 25)  # –ú–∏–Ω–∏–º—É–º –¥–ª—è —Ç–æ–≤–∞—Ä–∞
                optimal_width = min(optimal_width, 60)  # –ú–∞–∫—Å–∏–º—É–º –¥–ª—è —Ç–æ–≤–∞—Ä–∞
            elif data_key in ["price", "total_amount", "vat_amount"]:
                optimal_width = max(optimal_width, 15)  # –ú–∏–Ω–∏–º—É–º –¥–ª—è –¥–µ–Ω–µ–∂–Ω—ã—Ö –ø–æ–ª–µ–π
                optimal_width = min(optimal_width, 25)  # –ú–∞–∫—Å–∏–º—É–º –¥–ª—è –¥–µ–Ω–µ–∂–Ω—ã—Ö –ø–æ–ª–µ–π
            else:
                optimal_width = min(optimal_width, 30)  # –û–±—â–∏–π –º–∞–∫—Å–∏–º—É–º
            
            max_lengths[col_idx] = optimal_width
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ —à–∏—Ä–∏–Ω—ã
        for col_idx, optimal_width in max_lengths.items():
            excel_col = self.layout.START_COLUMN + col_idx
            col_letter = get_column_letter(excel_col)
            ws.column_dimensions[col_letter].width = optimal_width
        
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        import logging
        logger = logging.getLogger(__name__)
        logger.info(f"üìè –ê–≤—Ç–æ–ø–æ–¥–±–æ—Ä —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞:")
        for col_idx, optimal_width in max_lengths.items():
            col_name = self.layout.COLUMNS[col_idx].header
            logger.info(f"   {col_name}: {optimal_width}")


class MultiSheetBuilder:
    """
    Builder for creating multi-sheet reports (Brief + Detailed).
    
    –°–æ–∑–¥–∞–µ—Ç Excel —Ñ–∞–π–ª —Å –¥–≤—É–º—è –ª–∏—Å—Ç–∞–º–∏: "–ö—Ä–∞—Ç–∫–∏–π" –∏ "–ü–æ–ª–Ω—ã–π".
    –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É –æ–±—ã—á–Ω–æ–≥–æ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –º–∞–∫–µ—Ç–æ–≤.
    """
    
    def __init__(self):
        self.brief_builder = WorksheetBuilder()
        self.detailed_builder = DetailedWorksheetBuilder()
    
    def create_multi_sheet_workbook(self) -> Workbook:
        """
        Create workbook with both brief and detailed sheets.
        
        Returns:
            Workbook with "–ö—Ä–∞—Ç–∫–∏–π" and "–ü–æ–ª–Ω—ã–π" sheets
        """
        workbook = Workbook()
        
        # Remove default sheet if exists
        if workbook.worksheets:
            workbook.remove(workbook.active)
        
        # Create brief sheet first
        brief_ws = self.brief_builder.create_worksheet(workbook, "–ö—Ä–∞—Ç–∫–∏–π")
        
        # Create detailed sheet
        detailed_ws = self.detailed_builder.create_detailed_worksheet(workbook, "–ü–æ–ª–Ω—ã–π")
        
        return workbook
    
    def get_brief_worksheet(self, workbook: Workbook) -> Worksheet:
        """Get brief worksheet from multi-sheet workbook."""
        return workbook["–ö—Ä–∞—Ç–∫–∏–π"]
    
    def get_detailed_worksheet(self, workbook: Workbook) -> Worksheet:
        """Get detailed worksheet from multi-sheet workbook."""
        return workbook["–ü–æ–ª–Ω—ã–π"] 