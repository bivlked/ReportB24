#!/bin/bash
# üîí Pre-commit hook –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ ReportB24
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–∞–π–ª—ã –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —É—Ç–µ—á–µ–∫ webhook –∏ —Å–µ–∫—Ä–µ—Ç–æ–≤

set -e

echo "üîç –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Python
if ! command -v python &> /dev/null; then
    echo "‚ùå Python –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏."
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
if [ ! -f "scripts/security_check.py" ]; then
    echo "‚ùå –°–∫—Ä–∏–ø—Ç security_check.py –Ω–µ –Ω–∞–π–¥–µ–Ω."
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏."
    exit 1
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
echo "üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —É—Ç–µ—á–∫–∏ —Å–µ–∫—Ä–µ—Ç–æ–≤..."
if ! python scripts/security_check.py --quiet; then
    echo ""
    echo "üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É—Ç–µ—á–∫–∏ —Å–µ–∫—Ä–µ—Ç–æ–≤!"
    echo ""
    echo "üìã –î–ï–ô–°–¢–í–ò–Ø:"
    echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç—á–µ—Ç –≤—ã—à–µ"
    echo "2. –£–¥–∞–ª–∏—Ç–µ/–∑–∞–º–∞—Å–∫–∏—Ä—É–π—Ç–µ –≤—Å–µ —Ä–µ–∞–ª—å–Ω—ã–µ webhook URL"
    echo "3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–º–µ—Ä—ã: https://your-portal.bitrix24.ru/rest/***/***/"
    echo "4. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∫–æ–º–º–∏—Ç –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
    echo ""
    echo "üìö –ü–æ–¥—Ä–æ–±–Ω–µ–µ: memory-bank/security-guidelines.md"
    exit 1
fi

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ webhook (–±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
if git diff --cached --name-only | xargs grep -l "bitrix24\.ru/rest/.*/[a-zA-Z0-9_]\{10,\}/" 2>/dev/null; then
    echo "‚ùå –ù–∞–π–¥–µ–Ω –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π webhook URL –≤ staged —Ñ–∞–π–ª–∞—Ö!"
    echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∞—Å–∫–∏: https://your-portal.bitrix24.ru/rest/***/***/"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã Memory Bank –Ω–∞ –æ—Å–æ–±—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
if git diff --cached --name-only | grep -E "memory-bank/.*\.md$" | xargs grep -l "https://[^/]*\.bitrix24\.[^/]*/rest/[^/]*/[^/\*]{5,}/" 2>/dev/null; then
    echo "‚ùå Memory Bank —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ URL!"
    echo "–í—Å–µ webhook –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω—ã."
    exit 1
fi

echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
echo "üöÄ –ö–æ–º–º–∏—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω."
exit 0