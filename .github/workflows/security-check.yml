# üîí GitHub Actions: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
# –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º push –∏ pull request

name: üõ°Ô∏è Security Check

on:
  push:
    branches: [ main, develop, security-* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞–º –≤ 09:00 UTC
    - cron: '0 9 * * 1'

jobs:
  security-audit:
    name: üîç Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: üîí Run security tests
      run: |
        echo "üîç –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏..."
        if [ -d "tests" ] && [ "$(find tests -name '*.py' | wc -l)" -gt 0 ]; then
          echo "‚úÖ –ù–∞–π–¥–µ–Ω—ã —Ç–µ—Å—Ç—ã, –∑–∞–ø—É—Å–∫–∞–µ–º pytest..."
          pytest tests/ -v --tb=short || echo "‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
        else
          echo "‚ÑπÔ∏è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è tests –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –ø—É—Å—Ç–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º pytest"
        fi

    - name: üìã Check for webhook patterns
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ webhook —É—Ç–µ—á–∫–∏..."
        FOUND_WEBHOOKS=0
        if grep -r "https://.*\.bitrix24\..*/" . --exclude-dir=.git --exclude-dir=node_modules --exclude-dir=.github 2>/dev/null; then
          echo "‚ùå –ù–∞–π–¥–µ–Ω—ã –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ webhook URL!"
          FOUND_WEBHOOKS=1
        else
          echo "‚úÖ Webhook —É—Ç–µ—á–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
        fi
        if [ $FOUND_WEBHOOKS -eq 1 ]; then
          exit 1
        fi

    - name: üß† Memory Bank security check
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Memory Bank..."
        if [ -d "memory-bank" ]; then
          FOUND_ISSUES=0
          if find memory-bank/ -name "*.md" -exec grep -l "https://.*\.bitrix24\..*/" {} \; 2>/dev/null | head -1 | grep -q .; then
            echo "‚ùå Memory Bank —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ webhook!"
            FOUND_ISSUES=1
          else
            echo "‚úÖ Memory Bank –±–µ–∑–æ–ø–∞—Å–µ–Ω"
          fi
          if [ $FOUND_ISSUES -eq 1 ]; then
            exit 1
          fi
        else
          echo "‚ÑπÔ∏è Memory Bank –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É"
        fi