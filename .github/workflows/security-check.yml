# üîí GitHub Actions: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
# –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º push –∏ pull request

name: üõ°Ô∏è Security Check

on:
  push:
    branches: [ main, develop, security-* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞–º –≤ 09:00 UTC
    - cron: '0 9 * * 1'

jobs:
  security-audit:
    name: üîç Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: üîí Run security tests
      run: |
        echo "üîç –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ pytest..."
        pytest tests/ -v --tb=short

    - name: üìã Check for webhook patterns
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ webhook —É—Ç–µ—á–∫–∏..."
        if grep -r "https://[^/]*\.bitrix24\.[^/]*/rest/[^/]*/[^/\*]{10,}/" . --exclude-dir=.git --exclude-dir=node_modules; then
          echo "‚ùå –ù–∞–π–¥–µ–Ω—ã –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ webhook URL!"
          exit 1
        else
          echo "‚úÖ Webhook —É—Ç–µ—á–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
        fi

    - name: üß† Memory Bank security check
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Memory Bank..."
        if find memory-bank/ -name "*.md" -exec grep -l "https://[^/]*\.bitrix24\.[^/]*/rest/[^/]*/[^/\*]{5,}/" {} \; | head -1 | grep -q .; then
          echo "‚ùå Memory Bank —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ webhook!"
          exit 1
        else
          echo "‚úÖ Memory Bank –±–µ–∑–æ–ø–∞—Å–µ–Ω"
        fi